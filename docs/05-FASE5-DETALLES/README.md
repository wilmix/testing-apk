# ‚úÖ FASE 5: DETALLES DIN√ÅMICOS - APPROVAL POINT 2

Lista din√°mica de extintores con cascada Unidad‚ÜíCapacidad y validaci√≥n real-time

## Componentes Creados

### DetallesForm
- **Ubicaci√≥n**: `src/components/OrdenTrabajo/DetallesForm.tsx`
- **Props**: `data`, `onDataChange`, `onContinue`, `isDark`

#### Caracter√≠sticas:
- ‚úÖ Lista din√°mica de extintores (add/remove)
- ‚úÖ Collapsible items (expande/contrae cada extintor)
- ‚úÖ Cascada: Unidad dropdown ‚Üí Capacidad dropdown (opciones filtradas)
- ‚úÖ Validaci√≥n real-time con Zod (DetallesSchema)
- ‚úÖ **Validaci√≥n individual por extintor** (validateSingleDetalle)
- ‚úÖ Validaci√≥n por campo (extintorNro, unidad, capacidad, marca, tipo)
- ‚úÖ Feedback visual (‚úì v√°lido, ‚úó error, por item)
- ‚úÖ Status box (muestra cantidad de extintores, estado validaci√≥n)
- ‚úÖ Info box (instrucciones: cascada, m√≠nimo 1)
- ‚úÖ Bot√≥n continuar (activo solo si todos v√°lidos)
- ‚úÖ Bot√≥n agregar (add new extintor con ID √∫nico)
- ‚úÖ **Bot√≥n "Guardar y Siguiente"** (valida ‚Üí colapsa ‚Üí crea siguiente ‚Üí expande)
- ‚úÖ **Bot√≥n "Remover Extintor"** (siempre visible, resetea si es el √∫ltimo)
- ‚úÖ **Haptic feedback** (success, error, light) en acciones principales

---

## Funcionalidad Detallada

### 1. Generar IDs √önicos
```typescript
const generateId = (): string => {
  return `extintor_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
}
```

### 2. Cascada Unidad ‚Üí Capacidad
```typescript
const getCapacidadOptions = (unidad: string): string[] => {
  if (!unidad) return []
  const values = CAPACIDAD_VALORES[unidad as keyof typeof CAPACIDAD_VALORES] || []
  return Array.from(values)
}
```

**Comportamiento**:
- Si selecciona UNIDAD ‚Üí solo aparecen CAPACIDADES para esa unidad
- Si cambia UNIDAD ‚Üí reseteaCapacidad autom√°ticamente
- Si no hay UNIDAD seleccionada ‚Üí no muestra dropdown de Capacidad

### 3. Add/Remove Extintores

#### Bot√≥n "Guardar y Siguiente" ‚úÖ (Nuevo - Enero 2025)
**Flujo automatizado para agregar extintores:**
```typescript
const handleSaveAndNext = async (detalleId: string) => {
  // 1. Validar extintor actual
  const validation = validateSingleDetalle(detalleId)

  if (!validation.valid) {
    // Marcar todos los campos como tocados
    // Mostrar errores
    await haptic.trigger(HapticType.ERROR)
    return
  }

  // 2. Validaci√≥n exitosa
  await haptic.trigger(HapticType.SUCCESS)

  // 3. Colapsar extintor actual
  setExpandedDetalleId(null)

  // 4. Auto-crear siguiente extintor vac√≠o
  const newDetalle = { id: generateId(), ...camposVacios }

  // 5. Expandir el nuevo autom√°ticamente (delay 100ms)
  setTimeout(() => setExpandedDetalleId(newDetalle.id), 100)
}
```

**Caracter√≠sticas:**
- ‚úÖ Valida el extintor actual antes de continuar
- ‚úÖ Si inv√°lido: marca errores, vibra error, NO contin√∫a
- ‚úÖ Si v√°lido: vibra success, colapsa actual, crea siguiente, expande siguiente
- ‚úÖ Flujo completamente autom√°tico (UX optimizada)
- ‚úÖ Disponible desde el primer extintor

#### Bot√≥n "Remover Extintor" üóëÔ∏è (Actualizado - Enero 2025)
**Siempre visible con l√≥gica inteligente:**
```typescript
const handleRemoveDetalle = async (detalleId: string) => {
  if (data.detalles.length === 1) {
    // Si es el √∫ltimo: RESETEAR en lugar de remover
    const resetDetalle = { ...data.detalles[0], ...camposVacios }
    onDataChange({ detalles: [resetDetalle] })
    await haptic.trigger(HapticType.LIGHT)
    return
  }

  // Si hay 2+: remover normalmente
  const updatedDetalles = data.detalles.filter(d => d.id !== detalleId)
  onDataChange({ detalles: updatedDetalles })
  await haptic.trigger(HapticType.LIGHT)
}
```

**Caracter√≠sticas:**
- ‚úÖ **Siempre visible** (incluso con 1 solo extintor)
- ‚úÖ Si es el √∫ltimo: resetea campos en lugar de eliminar
- ‚úÖ Si hay 2+: elimina normalmente
- ‚úÖ Vibra (light) al ejecutar acci√≥n

#### Bot√≥n "Agregar otro extintor" ‚ûï
- **Add**: Crea nuevo extintor con ID √∫nico, lo agrega al final de la lista
- **Expand**: Click en header abre/cierra los campos del extintor

### 4. Validaci√≥n

#### Validaci√≥n Individual (Nuevo - Enero 2025)
```typescript
const validateSingleDetalle = (detalleId: string): { valid: boolean; errors: string[] } => {
  const detalle = data.detalles.find(d => d.id === detalleId)
  if (!detalle) return { valid: false, errors: ['Extintor no encontrado'] }

  // Validar con DetalleExtintorSchema
  const validation = validateData(DetalleExtintorSchema, detalle)

  if (validation.valid) {
    return { valid: true, errors: [] }
  } else {
    const errorMessages = Object.values(validation.errors)
    return { valid: false, errors: errorMessages }
  }
}
```

**Uso:** Llamado por "Guardar y Siguiente" para validar antes de continuar

#### Validaci√≥n Visual Simple
```typescript
// Por extintor (visual en header)
const isValid =
  !!detalle.extintorNro &&
  !!detalle.capacidadUnidad &&
  !!detalle.capacidadValor &&
  !!detalle.marca &&
  !!detalle.tipo

// Por formulario completo
const isFormValid =
  validation.valid &&  // DetallesSchema
  data.detalles.length > 0
```

#### Schemas Zod
```typescript
// Individual
DetalleExtintorSchema: z.object({
  id: z.string().min(1),
  extintorNro: z.string().min(1).regex(/^\d{1,10}$/),
  capacidadUnidad: z.string().min(1),
  capacidadValor: z.string().min(1),
  marca: z.string().min(1),
  tipo: z.string().min(1)
})

// Array completo
DetallesSchema: z.object({
  detalles: z.array(DetalleExtintorSchema).min(1, 'M√≠nimo 1 extintor')
})
```

### 5. Touch Tracking
- Rastrear qu√© campos han sido tocados por extintor
- Solo mostrar error si campo fue tocado (mejor UX)
- Reset cuando se remueve un extintor
- **Actualizaci√≥n autom√°tica de touched** cuando "Guardar y Siguiente" valida

### 6. Haptic Feedback (Nuevo - Enero 2025)
**Retroalimentaci√≥n t√°ctil en acciones principales:**

```typescript
const haptic = useHapticFeedback()

// Success: guardar v√°lido
await haptic.trigger(HapticType.SUCCESS)  // 1 vibraci√≥n corta suave

// Error: validaci√≥n fallida
await haptic.trigger(HapticType.ERROR)    // 3 vibraciones intensas

// Light: remover/resetear
await haptic.trigger(HapticType.LIGHT)    // 1 vibraci√≥n micro
```

**Contextos de uso:**
- ‚úÖ "Guardar y Siguiente" exitoso ‚Üí Success
- ‚ùå "Guardar y Siguiente" con errores ‚Üí Error
- üóëÔ∏è "Remover Extintor" ‚Üí Light

---

## Integraci√≥n en App.tsx

- ‚úÖ DetallesForm importado
- ‚úÖ Button "üìã DetallesForm" (verde) para probar
- ‚úÖ Estado para mostrar/ocultar DetallesForm
- ‚úÖ Estado para guardar datos (detallesFormData)
- ‚úÖ Tests en runTests() funci√≥n
- ‚úÖ Renderiza en pantalla completa
- ‚úÖ Button "‚Üê Volver" para regresar
- ‚úÖ Dark theme completo

---

## Tests Implementados

En `App.tsx`:
- ‚úÖ DetallesForm component render
- ‚úÖ Validaci√≥n DetallesSchema
- ‚úÖ Cascada unidad‚Üícapacidad
- ‚úÖ Add/remove extintores
- ‚úÖ Touch tracking
- ‚úÖ AsyncStorage persistence (ready)

**Todos pasan en Expo Go ‚úÖ**

---

## Flujo de Usuario

### Flujo Optimizado (Enero 2025) üÜï
**Usando "Guardar y Siguiente" (recomendado):**

1. **Pantalla inicial**: Muestra 1 extintor vac√≠o expandido
2. **Rellenar datos del extintor 1**:
   - N¬∫ Extintor (texto num√©rico, 1-10 d√≠gitos)
   - Unidad (dropdown: KILOS, LIBRAS, LITROS)
   - Capacidad (dropdown din√°mico seg√∫n unidad)
   - Marca (dropdown searchable)
   - Tipo (dropdown: ABC, BC, CO2, etc)
3. **Click "‚úÖ Guardar y Siguiente"**:
   - ‚úÖ Si v√°lido: vibra success ‚Üí colapsa ‚Üí crea siguiente ‚Üí expande autom√°ticamente
   - ‚ùå Si inv√°lido: vibra error ‚Üí muestra errores en campos ‚Üí permanece expandido
4. **Rellenar extintor 2** (reci√©n creado y expandido autom√°ticamente)
5. **Repetir** paso 3-4 para cada extintor
6. **√öltimo extintor**: Despu√©s de "Guardar y Siguiente", se crea uno m√°s (puedes ignorarlo)
7. **Click "‚úÖ Continuar ‚Üí"** (abajo) cuando termines

**Ventajas:**
- ‚ö° Flujo r√°pido y autom√°tico
- ‚úÖ Validaci√≥n inmediata por extintor
- üéØ Foco autom√°tico en siguiente extintor
- üì≥ Feedback h√°ptico en tiempo real

### Flujo Manual (Tradicional)
1. **Pantalla inicial**: Muestra 1 extintor vac√≠o (m√≠nimo obligatorio)
2. **Agregar m√°s**: Click "+ Agregar otro extintor" crea nuevo item
3. **Expandir**: Click en header para expandir/colapsar manualmente
4. **Rellenar datos** en cada extintor
5. **Validaci√≥n**: Feedback visual por campo (‚úì/‚úó)
6. **Status box**: Muestra cantidad total y estado validaci√≥n
7. **Continuar**: Activa cuando todos los extintores est√°n completos
8. **Remover**: Click "üóëÔ∏è Remover Extintor" (siempre visible, resetea si es el √∫ltimo)

---

## Estructura de Datos

```typescript
interface DetalleExtintor {
  id: string                    // √önico, generado con timestamp + random
  extintorNro: string          // "001", "102", etc
  capacidadUnidad: string      // "KILOS", "LITROS", etc
  capacidadValor: string       // "6 KILOS", "2.5 LITROS", etc
  marca: string               // "KIDDE BRASIL", etc
  tipo: string                // "ABC", "CO2", etc
}
```

---

## Estilos y Tema

### Dark Mode Support:
- Container: `#1a1a1a` / `#f5f5f5`
- Detalle header: `#2a2a2a` / `#ffffff`
- Detalle content: `#222222` / `#fafafa`
- Botones: Themeable con `theme.success`, `theme.error`, etc.

### Layout de Botones de Acci√≥n (Nuevo - Enero 2025)
**Dise√±o profesional con estilos ghost:**

```typescript
// Contenedor
actionsContainer: {
  gap: 12,          // Espacio entre botones
  marginTop: 8,
}

// Bot√≥n "Guardar y Siguiente" (verde, prominente)
saveButton: {
  paddingVertical: 14,
  paddingHorizontal: 16,
  borderRadius: 8,
  alignItems: 'center',
  borderWidth: 1.5,
  backgroundColor: 'transparent',  // Ghost style
  borderColor: theme.success,
}
saveButtonText: {
  fontSize: 15,
  fontWeight: '600',
  letterSpacing: 0.3,
  color: theme.success,
}

// Bot√≥n "Remover" (rojo, discreto)
removeButton: {
  paddingVertical: 12,
  paddingHorizontal: 16,
  borderRadius: 8,
  alignItems: 'center',
  borderWidth: 1,
  backgroundColor: 'transparent',  // Ghost style
  borderColor: theme.error,
}
removeButtonText: {
  fontSize: 14,
  fontWeight: '500',
  opacity: 0.9,
  color: theme.error,
}
```

**Caracter√≠sticas:**
- üé® Botones ghost (transparentes, solo bordes)
- üü¢ Verde para acci√≥n primaria (Guardar y Siguiente)
- üî¥ Rojo discreto para acci√≥n destructiva (Remover)
- üìê Layout vertical con separaci√≥n clara
- ‚ôø Touch-friendly: altura m√≠nima 44px

### Touch-Friendly:
- Input height: 44px m√≠nimo
- Button height: 48px+ (Guardar: 14px√ó2 + 16px√ó2 = 60px total)
- Spacing: 12-20px gaps
- Collapsible logic para reducir scroll

---

## Status

**Status**: ‚úÖ COMPLETADA + MEJORADA UX (Enero 2025)

**Archivos**:
- ‚úÖ src/components/OrdenTrabajo/DetallesForm.tsx (~800 l√≠neas, mejorada)
- ‚úÖ src/components/index.ts (actualizado)
- ‚úÖ App.tsx (integrado + tests)
- ‚úÖ docs/05-FASE5-DETALLES/README.md (esta documentaci√≥n)

**Mejoras UX implementadas (Enero 2025)**:
- ‚úÖ Validaci√≥n individual por extintor (`validateSingleDetalle`)
- ‚úÖ Bot√≥n "Guardar y Siguiente" con flujo automatizado
- ‚úÖ Bot√≥n "Remover" siempre visible (resetea si es el √∫ltimo)
- ‚úÖ Haptic feedback en acciones principales
- ‚úÖ Layout profesional con botones ghost
- ‚úÖ Flujo optimizado: valida ‚Üí colapsa ‚Üí crea ‚Üí expande

**Pr√≥xima fase**: FASE 6 - Final Form + Submit

---

**Total FASE 5**: ~2-3 horas iniciales + 1 hora mejoras UX = ~3-4 horas ‚úÖ

